<!DOCTYPE html><html lang="zh-Hans"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> 过滤豆瓣租房小组中介贴之 python 实现余弦相似度（一） · 程序化思维</title><meta name="description" content="过滤豆瓣租房小组中介贴之 python 实现余弦相似度（一） - facert"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="https://facert.github.io/atom.xml" title="程序化思维"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="https://github.com/facert" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">过滤豆瓣租房小组中介贴之 python 实现余弦相似度（一）</h1><div class="post-info">Nov 24, 2016</div><div class="post-content"><p>前几天做了个<a href="https://zhuanlan.zhihu.com/p/23798922" target="_blank" rel="noopener">微信找房机器人</a>, 爬取豆瓣租房小组的时候发现很多伪装的中介帖，如下这种格式：</p>
<blockquote>
<p>可月付 无中介 方庄地铁附近 芳城园一区单间出租</p>
<p>可月付 无中介 方庄地铁附近 芳城园一区主卧次卧出租</p>
<p>方庄地铁附近 芳城园一区次卧出租</p>
</blockquote>
<a id="more"></a>
<p>豆瓣对于小组的帖子有个简单的过滤，如果标题完全一样，就会直接删除，所以中介们一般都会在标题改几个字，内容也会调整下顺序。其实对于这种问题，有简单的方案实现，比如下文介绍的余弦相似度。</p>
<p>关于余弦相似度的原理其实很简单，参考这篇文章<a href="http://www.ruanyifeng.com/blog/2013/03/cosine_similarity.html" target="_blank" rel="noopener">TF-IDF与余弦相似性的应用（二）：找出相似文章</a><br><img src="/media/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202016-11-24%20%E4%B8%8B%E5%8D%882.25.45.png" alt="屏幕快照 2016-11-24 下午2.25.45"></p>
<p>python 实现如下：</p>
<p>(一) 对文本分词</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cut_word</span><span class="params">(content)</span>:</span></span><br><span class="line">    tags = jieba.analyse.extract_tags(content, withWeight=<span class="keyword">True</span>, topK=<span class="number">20</span>)</span><br><span class="line">    <span class="keyword">return</span> tags</span><br></pre></td></tr></table></figure>
<p>这里用了 jieba ,分词什么的它太有用了<br>返回结果<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&apos;&apos;&apos;</span><br><span class="line">(u&apos;\u65b9\u5e84&apos;, 2.4582479479)</span><br><span class="line">(u&apos;\u82b3\u57ce\u56ed&apos;, 1.19547675029)</span><br><span class="line">(u&apos;\u53ef\u6708\u4ed8&apos;, 1.19547675029)</span><br><span class="line">(u&apos;\u4e00\u533a&apos;, 1.04666904475)</span><br><span class="line">(u&apos;\u5355\u95f4&apos;, 1.02371160058)</span><br><span class="line">(u&apos;\u51fa\u79df&apos;, 0.832472854883)</span><br><span class="line">(u&apos;\u5730\u94c1&apos;, 0.8200234078590001)</span><br><span class="line">(u&apos;\u4e2d\u4ecb&apos;, 0.7891864466530001)</span><br><span class="line">(u&apos;\u9644\u8fd1&apos;, 0.516934129144)</span><br><span class="line">&apos;&apos;&apos;</span><br></pre></td></tr></table></figure></p>
<p>(二) 返回两个文本词频的多维向量</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">merge_tag</span><span class="params">(tag1=None, tag2=None)</span>:</span></span><br><span class="line"></span><br><span class="line">    v1 = []</span><br><span class="line">    v2 = []</span><br><span class="line">    tag_dict1 = &#123;i[<span class="number">0</span>]: i[<span class="number">1</span>] <span class="keyword">for</span> i <span class="keyword">in</span> tag1&#125;</span><br><span class="line">    tag_dict2 = &#123;i[<span class="number">0</span>]: i[<span class="number">1</span>] <span class="keyword">for</span> i <span class="keyword">in</span> tag2&#125;</span><br><span class="line">    merged_tag = set(tag_dict1.keys()+tag_dict2.keys())</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> merged_tag:</span><br><span class="line">        <span class="keyword">if</span> i <span class="keyword">in</span> tag_dict1:</span><br><span class="line">            v1.append(tag_dict1[i])</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            v1.append(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> i <span class="keyword">in</span> tag_dict2:</span><br><span class="line">            v2.append(tag_dict2[i])</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            v2.append(<span class="number">0</span>)</span><br><span class="line">    <span class="keyword">return</span> v1, v2</span><br></pre></td></tr></table></figure>
<p>(三) 计算余弦相似度</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dot_product</span><span class="params">(v1, v2)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> sum(a * b <span class="keyword">for</span> a, b <span class="keyword">in</span> zip(v1, v2))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">magnitude</span><span class="params">(vector)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> sqrt(dot_product(vector, vector))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">similarity</span><span class="params">(v1, v2)</span>:</span></span><br><span class="line">    <span class="string">'''计算余弦相似度</span></span><br><span class="line"><span class="string">    '''</span></span><br><span class="line">    <span class="keyword">return</span> dot_product(v1, v2) / (magnitude(v1) * magnitude(v2) + <span class="number">.00000000001</span>)</span><br></pre></td></tr></table></figure>
<p>(四) 结果<br>我们取一些样本做例子，内容为标题+详情</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># https://www.douban.com/group/topic/93410497/</span></span><br><span class="line">    content1 = <span class="string">u"""</span></span><br><span class="line"><span class="string">                可月付 无中介 方庄地铁附近 芳城园一区单间出租</span></span><br><span class="line"><span class="string">                我的房子在方庄地铁附近的芳城园一区，正规小区楼房，</span></span><br><span class="line"><span class="string">                三家合住，现出租一间主卧和一间带小阳台次卧，室内家电齐全，</span></span><br><span class="line"><span class="string">                冰箱，洗衣机等都有，可洗澡上网，做饭都可以，小区交通便利，四通八达，</span></span><br><span class="line"><span class="string">                希望入住的是附近正常上班的朋友</span></span><br><span class="line"><span class="string">                """</span></span><br><span class="line">    <span class="comment"># https://www.douban.com/group/topic/93410328/</span></span><br><span class="line">    content2 = <span class="string">u"""</span></span><br><span class="line"><span class="string">                可月付 无中介 方庄地铁附近 芳城园一区主卧次卧出租</span></span><br><span class="line"><span class="string">                我的房子在方庄地铁附近的芳城园一区，正规小区楼房，</span></span><br><span class="line"><span class="string">                三家合住，现出租一间主卧和一间带小阳台次卧，室内家电齐全，</span></span><br><span class="line"><span class="string">                冰箱，洗衣机等都有，可洗澡上网，做饭都可以，小区交通便利，四通八达，</span></span><br><span class="line"><span class="string">                希望入住的是附近正常上班的朋友</span></span><br><span class="line"><span class="string">                """</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># https://www.douban.com/group/topic/93410308/</span></span><br><span class="line">    content3 = <span class="string">u"""方庄地铁附近 芳城园一区次卧出租</span></span><br><span class="line"><span class="string">                    我的房子在方庄地铁附近的芳城园一区，正规小区楼房，</span></span><br><span class="line"><span class="string">                    三家合住，现出租一间主卧和一间带小阳台次卧，室内家电齐全，</span></span><br><span class="line"><span class="string">                    冰箱，洗衣机等都有，可洗澡上网，做饭都可以，小区交通便利，四通八达，</span></span><br><span class="line"><span class="string">                    希望入住的是附近正常上班的朋友</span></span><br><span class="line"><span class="string">                    """</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># https://www.douban.com/group/topic/93381171/</span></span><br><span class="line">    content4 = <span class="string">u"""二环玉蜓桥旁下月27号后可入住二居</span></span><br><span class="line"><span class="string">                方庄方古园一区5号楼下月27日到期出租，</span></span><br><span class="line"><span class="string">                我是房主无中介费 ，新一年租6000元每月押一付三，主次卧可分开住。</span></span><br><span class="line"><span class="string">                距地铁5号线蒲黄榆站5分钟路程。房屋60平正向，另有看守固定车位。</span></span><br></pre></td></tr></table></figure>
<p>测试结果如下， 越接近 1 则两者文章越相似</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">content1 和 content2 相似度为: 0.968802386285</span><br><span class="line">content1 和 content3 相似度为: 0.926323584519</span><br><span class="line">content2 和 content3 相似度为: 0.921885685549</span><br><span class="line">content2 和 content4 相似度为: 0.174889264654</span><br></pre></td></tr></table></figure>
<p>说明 content1 content2 content3 很可能是中介批量发的帖子</p>
<p>这次只是简单的研究下，如果要起到更好效果，就得有这些关键词的语料，然后加权重。<br>代码见 <a href="https://gist.github.com/facert/097af928b50ef9946513c7a5b42ec5c2" target="_blank" rel="noopener">cosine_similarity.py</a></p>
</div></article></div></main><footer><div class="paginator"><a href="/2016/11/30/用-python-提高效率/" class="prev">PREV</a><a href="/2016/11/21/如何通过-python-实现一个-正经-tumblr-爬虫/" class="next">NEXT</a></div><div class="copyright"><p>© 2021 <a href="https://facert.github.io">facert</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script></body></html>